name: ðŸ” Snyk Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'

permissions:
  contents: read
  security-events: write

jobs:
  ##############################################################################
  # Snyk Dependency Vulnerability Scan
  ##############################################################################
  snyk-dependencies:
    name: Dependency Vulnerabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install Dependencies
        run: bun install --frozen-lockfile
      
      - name: Setup Snyk
        uses: snyk/actions/setup@master
      
      - name: Snyk Auth
        run: snyk auth ${{ secrets.SNYK_TOKEN }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      
      - name: Snyk Dependency Test
        id: snyk-deps
        run: |
          snyk test --all-projects --severity-threshold=high --json > snyk-results.json || true
          snyk test --all-projects --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: Upload Snyk Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-dependency-results
          path: snyk-results.json
          retention-days: 30
      
      - name: Snyk Monitor (track in dashboard)
        if: github.ref == 'refs/heads/main'
        run: snyk monitor --all-projects
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      
      - name: Generate Summary
        if: always()
        run: |
          if [ "${{ steps.snyk-deps.outcome }}" == "success" ]; then
            echo "## âœ… Snyk Dependency Scan Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No high or critical vulnerabilities found in dependencies." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Snyk Found Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "High or critical severity vulnerabilities detected." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Actions:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the Snyk results artifact" >> $GITHUB_STEP_SUMMARY
            echo "2. Run \`snyk wizard\` locally to fix issues" >> $GITHUB_STEP_SUMMARY
            echo "3. Update vulnerable packages" >> $GITHUB_STEP_SUMMARY
          fi

  ##############################################################################
  # Snyk Code (SAST) Scan
  ##############################################################################
  snyk-code:
    name: Code Security (SAST)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Snyk
        uses: snyk/actions/setup@master
      
      - name: Snyk Code Test
        id: snyk-code
        run: |
          snyk code test --severity-threshold=high --json > snyk-code-results.json || true
          snyk code test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: Upload Snyk Code Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-code-results
          path: snyk-code-results.json
          retention-days: 30
      
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-code-results.json
        continue-on-error: true
      
      - name: Generate Summary
        if: always()
        run: |
          if [ "${{ steps.snyk-code.outcome }}" == "success" ]; then
            echo "## âœ… Snyk Code Scan Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No high or critical code security issues found." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Snyk Code Found Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Security issues detected in source code." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review findings in GitHub Security tab or Snyk dashboard." >> $GITHUB_STEP_SUMMARY
          fi

  ##############################################################################
  # Snyk IaC (Infrastructure as Code) Scan
  ##############################################################################
  snyk-iac:
    name: Infrastructure Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Snyk
        uses: snyk/actions/setup@master
      
      - name: Snyk IaC Test
        id: snyk-iac
        run: |
          # Scan Docker and config files
          snyk iac test --severity-threshold=high --json > snyk-iac-results.json || true
          snyk iac test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: Upload Snyk IaC Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-iac-results
          path: snyk-iac-results.json
          retention-days: 30
      
      - name: Generate Summary
        if: always()
        run: |
          if [ "${{ steps.snyk-iac.outcome }}" == "success" ]; then
            echo "## âœ… Snyk IaC Scan Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No high or critical infrastructure misconfigurations found." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Snyk IaC Found Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure security issues detected." >> $GITHUB_STEP_SUMMARY
          fi

  ##############################################################################
  # Security Summary
  ##############################################################################
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [snyk-dependencies, snyk-code, snyk-iac]
    if: always()
    
    steps:
      - name: Generate Final Summary
        run: |
          echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.snyk-dependencies.result == 'success' && 'âœ… Pass' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code (SAST) | ${{ needs.snyk-code.result == 'success' && 'âœ… Pass' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.snyk-iac.result == 'success' && 'âœ… Pass' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** [Snyk Dashboard](https://app.snyk.io)" >> $GITHUB_STEP_SUMMARY
